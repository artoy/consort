\let\oldvec\vec
\documentclass[runningheads]{llncs}
\usepackage{bcprules}\typicallabel{T-Hoge}
\usepackage{bcpproof}
\usepackage{graphicx,xcolor}
\usepackage{amsmath}
\usepackage{amssymb}
\usepackage{stmaryrd}
\usepackage{parcolumns}
\usepackage{cases}
\usepackage{listings}% http://ctan.org/pkg/listings
\usepackage{etoolbox}
\usepackage{microtype}
\usepackage{wrapfig}
\usepackage{paralist}
\usepackage[numbers,sectionbib,sort]{natbib}
\usepackage{cleveref}
\input{local}
\input{flow-lang}
\makeatletter
\def\admitted@what[#1]{\textcolor{red}{\textbf{[Admitted: that #1]}}}
\def\admitted@{\textcolor{red}{\textbf{Admitted}}\xspace}
\def\admitted{\@ifnextchar[{\admitted@what}{\admitted@}}
\makeatother
\begin{document}
Types and refinements:
\[
  \begin{array}{rrcl}
      \text{\scriptsize Types} & \tau % & \in & \mathbf{Types} \\
                                         &::=&  \set{  \nu  \COL \TINT \mid  \varphi }  \mid  \tau  \TREF^{ r }  \\
      \text{\scriptsize Ownership} & r & \in & [0,1] \\
      \text{\scriptsize Refinements} & \varphi & ::= & \varphi_{{\mathrm{1}}}  \vee  \varphi_{{\mathrm{2}}} \mid  \neg  \varphi  \mid  \top  \\
                               & & \mid & \phi  \ottsym{(}  \widehat{v}_{{\mathrm{1}}}  \ottsym{,} \, .. \, \ottsym{,}  \widehat{v}_{\ottmv{n}}  \ottsym{)} \\
                               & & \mid & \widehat{v}_{{\mathrm{1}}} \, \ottsym{=} \, \widehat{v}_{{\mathrm{2}}} \\
                                 & & \mid & \mathcal{CP} \\
    \text{\scriptsize Refinement Values} & \widehat{v} & ::= & \pi \mid n \mid \nu \\
    \text{\scriptsize Access Paths} & \pi & ::= & \mathit{x} \, \oldvec{\star} \\
    \text{\scriptsize Function Types} & \sigma & ::= &  \forall  \lambda .\tuple{ \mathit{x_{{\mathrm{1}}}} \COL \tau_{{\mathrm{1}}} ,\dots, \mathit{x_{\ottmv{n}}} \COL \tau_{\ottmv{n}} } \\ & & & \ra\tuple{ \mathit{x_{{\mathrm{1}}}} \COL \tau'_{{\mathrm{1}}} ,\dots, \mathit{x_{\ottmv{n}}} \COL \tau'_{\ottmv{n}}  \mid  \tau }  \\
    \text{\scriptsize Context Variables} & \lambda & \in & \CVar \\
    \text{\scriptsize Concrete Context} & \oldvec{\ell} & ::= & \ell  \ottsym{:}  \oldvec{\ell} \mid  \epsilon  \\
    \text{\scriptsize Pred. Context} & \mathcal{C} & ::= &  \ell  :  \mathcal{C}  \mid \lambda \mid  \epsilon  \\
    \text{\scriptsize Context Query} & \mathcal{CP} & ::= &   \oldvec{\ell}     \subseteq    \mathcal{C}  \\
    \text{\scriptsize Typing Context} & \mathcal{L} & ::= & \lambda \mid \oldvec{\ell} \\
  \end{array}
\]

An access path denotes a path through memory by a root variable and a potentially empty sequence of references $\oldvec{\star}$.
The empty sequence is denoted $ \epsilon $. We abbreviate $\mathit{x} \,  \epsilon $ as $\mathit{x}$.

Well-formedness:
\infrule[WF-Env]{
  \forall \,  \mathit{x}  \in \DOM( \Gamma )   \ottsym{.}   \mathcal{L}   \mid   \Gamma   \vdash _{\wf}  \Gamma  \ottsym{(}  \mathit{x}  \ottsym{)} 
}{
   \mathcal{L}   \vdash _{\wf}  \Gamma 
}
\infrule[WF-Int]{
   \mathcal{L}   \mid   \Gamma   \vdash _{\wf}  \varphi 
}{
   \mathcal{L}   \mid   \Gamma   \vdash _{\wf}   \set{  \nu  \COL \TINT \mid  \varphi }   
}
\infrule[WF-Ref]{
   \mathcal{L}   \mid   \Gamma   \vdash _{\wf}  \tau 
}{
   \mathcal{L}   \mid   \Gamma   \vdash _{\wf}   \tau  \TREF^{ r }  
}
\infrule[WF-Phi]{
  \Gamma  \vdash  \varphi \\
  \mathbf{FCV} \, \ottsym{(}  \varphi  \ottsym{)} \subseteq \ottkw{CV} \, \ottsym{(}  \mathcal{L}  \ottsym{)}
}{
   \mathcal{L}   \mid   \Gamma   \vdash _{\wf}  \varphi 
}
\infrule[WF-Result]{
   \mathcal{L}   \mid   \Gamma   \vdash _{\wf}  \tau  \andalso
   \mathcal{L}   \vdash _{\wf}  \Gamma 
}{
   \mathcal{L}   \vdash _{\wf}  \tau   \produces   \Gamma 
}
\infrule[WF-FunType]{
   \lambda   \vdash _{\wf}   \mathit{x_{{\mathrm{1}}}} \COL \tau_{{\mathrm{1}}} ,\ldots, \mathit{x_{\ottmv{n}}} \COL \tau_{\ottmv{n}}   \\  \lambda   \vdash _{\wf}  \tau   \produces    \mathit{x_{{\mathrm{1}}}} \COL \tau'_{{\mathrm{1}}} ,\ldots, \mathit{x_{\ottmv{n}}} \COL \tau'_{\ottmv{n}}  
}{
   \vdash _{\wf}   \forall  \lambda .\tuple{ \mathit{x_{{\mathrm{1}}}} \COL \tau_{{\mathrm{1}}} ,\dots, \mathit{x_{\ottmv{n}}} \COL \tau_{\ottmv{n}} }\ra\tuple{ \mathit{x_{{\mathrm{1}}}} \COL \tau'_{{\mathrm{1}}} ,\dots, \mathit{x_{\ottmv{n}}} \COL \tau'_{\ottmv{n}}  \mid  \tau }  
}
\infrule[WF-FunEnv]{
  \forall \,  \mathit{f}  \in \DOM( \Theta )   \ottsym{.}   \vdash _{\wf}  \Theta  \ottsym{(}  \mathit{f}  \ottsym{)} 
}{
   \vdash _{\wf}  \Theta 
}


Well-typed predicates:

\begin{center}
\bcprulessavespacetrue
\infax[Pr-Top]{ \Gamma  \vdash   \top  }
\infax[Pr-Top]{ \Gamma  \vdash  \mathcal{CP} }
\infrule[Pr-Not]{
  \Gamma  \vdash  \varphi
}{ \Gamma  \vdash   \neg  \varphi  }
\infrule[Pr-Or]{
  \Gamma  \vdash  \varphi_{{\mathrm{1}}} \andalso \Gamma  \vdash  \varphi_{{\mathrm{2}}}
}{ \Gamma  \vdash  \varphi_{{\mathrm{1}}}  \vee  \varphi_{{\mathrm{2}}} }

\infrule[Pr-Eq]{
  \Gamma  \vdash  \widehat{v}_{{\mathrm{1}}} \andalso \Gamma  \vdash  \widehat{v}_{{\mathrm{2}}}
}{ \Gamma  \vdash  \widehat{v}_{{\mathrm{1}}} \, \ottsym{=} \, \widehat{v}_{{\mathrm{2}}} }
\infrule[Pr-App]{
  \Gamma  \vdash  \widehat{v}_{{\mathrm{1}}} \andalso \cdots \andalso \Gamma  \vdash  \widehat{v}_{\ottmv{n}}
}{ \Gamma  \vdash  \phi  \ottsym{(}  \widehat{v}_{{\mathrm{1}}}  \ottsym{,} \, .. \, \ottsym{,}  \widehat{v}_{\ottmv{n}}  \ottsym{)}}
\bcprulessavespacefalse
\end{center}

Well-typed predicate values
\begin{center}
  \bcprulessavespacetrue
  \infax[Pv-Int]{ \Gamma  \vdash  n }
  \infax[Pv-Nu]{ \Gamma  \vdash  \nu }
  \infrule[Pv-AP]{
     \oldvec{\star}  \Downarrow  \Gamma  \ottsym{(}  \mathit{x}  \ottsym{)} 
  }{ \Gamma  \vdash  \mathit{x} \, \oldvec{\star} }

  \infax[AP-Eps]{   \epsilon   \Downarrow   \set{  \nu  \COL \TINT \mid \_ }   }
  \infrule[AP-Cons]{
     \oldvec{\star}  \Downarrow  \tau  \andalso r > 0
  }{
      \star  \, \oldvec{\star}  \Downarrow   \tau  \TREF^{ r }  
  }
  \bcprulessavespacefalse
\end{center}

The addition operator is defined as in the ESOP 2020 paper.

We assume that $\mathit{x} \, \oldvec{\star}$ is a valid variable in the underlying logic; it can be lifted to one using consistent substitution.

The denotation operation is defined as:

\begin{align*}
   \sem{ \Gamma  \ottsym{,}  \mathit{x}  \ottsym{:}  \tau }  & =  \sem{ \tau }_{ \mathit{x} }   \wedge   \sem{ \Gamma }  \\
   \sem{  \bullet  }  & =  \top  \\
   \sem{  \set{  \nu  \COL \TINT \mid  \varphi }  }_{ \pi }  & =  [  \pi  /  \nu  ]  \, \varphi \\
   \sem{  \tau  \TREF^{ r }  }_{ \mathit{x} \, \oldvec{\star} }  & =  \sem{ \tau }_{ \mathit{x} \, \oldvec{\star} \,  \star  }  
\end{align*}

We define a new strengthening operation $\tau  \wedge \, \nu \, \ottsym{=}  \pi$ as:

\begin{align*} 
   \set{  \nu  \COL \TINT \mid  \varphi }   \wedge \, \nu \, \ottsym{=}  \pi & \triangleq  \set{  \nu  \COL \TINT \mid   \varphi  \wedge  \nu \, \ottsym{=} \, \pi  }  \\
   \tau  \TREF^{ \ottsym{0} }   \wedge \, \nu \, \ottsym{=}  \pi & \triangleq  \tau  \TREF^{ \ottsym{0} }  \\
   \tau  \TREF^{ r }   \wedge \, \nu \, \ottsym{=}  \pi & \triangleq  \ottsym{(}  \tau  \wedge \, \nu \, \ottsym{=}  \pi \,  \star   \ottsym{)}  \TREF^{ r }  \text{ if ($r > 0$)}
\end{align*}

We now describe the type rules for the extended type system.
We omit the rules for \rn{T-Assert, T-Seq, T-If, T-LetInt, T-Var, T-Alias, T-AliasPtr, T-Sub} as they are unchanged.

\infrule[T-Assign]{
  (\text{The shapes of $\tau'$ and $\tau_{{\mathrm{2}}}$ are similar}) \\
   \mathcal{L}   \vdash _{\wf}   \Gamma  \setminus  \mathit{y}   \\
   \Theta   \mid   \mathcal{L}   \mid   \Gamma  \ottsym{[}  \mathit{x}  \hookleftarrow  \tau_{{\mathrm{1}}}  \wedge \, \nu \, \ottsym{=}  \mathit{y} \,  \star   \ottsym{]}  \ottsym{[}  \mathit{y}  \ottsym{:}   \ottsym{(}  \tau_{{\mathrm{2}}}  \wedge \, \nu \, \ottsym{=}  \mathit{x}  \ottsym{)}  \TREF^{ \ottsym{1} }   \ottsym{]}   \vdash   \ottnt{e}  :  \tau   \produces   \Gamma' 
}{  \Theta   \mid   \mathcal{L}   \mid   \Gamma  \ottsym{[}  \mathit{x}  \ottsym{:}  \tau_{{\mathrm{1}}}  \ottsym{+}  \tau_{{\mathrm{2}}}  \ottsym{]}  \ottsym{[}  \mathit{y}  \ottsym{:}   \tau'  \TREF^{ \ottsym{1} }   \ottsym{]}   \vdash    \mathit{y}  \WRITE  \mathit{x}  \SEQ  \ottnt{e}   :  \tau   \produces   \Gamma'  }

\infrule[T-Let]{
   \Theta   \mid   \mathcal{L}   \mid   \Gamma  \ottsym{[}  \mathit{x}  \hookleftarrow  \tau_{{\mathrm{1}}}  \wedge \, \nu \, \ottsym{=}  \mathit{y}  \ottsym{]}  \ottsym{,}  \mathit{y}  \ottsym{:}  \tau_{{\mathrm{2}}}  \wedge \, \nu \, \ottsym{=}  \mathit{x}   \vdash   \ottnt{e}  :  \tau   \produces   \Gamma'  \andalso  \mathit{x}  \not\in   \DOM( \Gamma )  
}{ \Theta   \mid   \mathcal{L}   \mid   \Gamma  \ottsym{[}  \mathit{x}  \ottsym{:}  \tau_{{\mathrm{1}}}  \ottsym{+}  \tau_{{\mathrm{2}}}  \ottsym{]}   \vdash    \LET  \mathit{x}  =  \mathit{y}  \IN  \ottnt{e}   :  \tau   \produces   \Gamma' }

\infrule[T-Deref]{
  \tau'_{{\mathrm{1}}} = \begin{cases}
    \tau_{{\mathrm{1}}}  \wedge \, \nu \, \ottsym{=}  \mathit{x} &  r   \ottsym{>}   \ottsym{0}  \\
    \tau_{{\mathrm{1}}} & r  \ottsym{=}  \ottsym{0}
  \end{cases}  \\
  \tau'_{{\mathrm{2}}} = \begin{cases}
    \tau_{{\mathrm{2}}}  \wedge \, \nu \, \ottsym{=}  \mathit{y} \,  \star  &  r   \ottsym{>}   \ottsym{0}  \\
    \tau_{{\mathrm{2}}} & r  \ottsym{=}  \ottsym{0}
  \end{cases} \\
   \Theta   \mid   \mathcal{L}   \mid   \Gamma  \ottsym{[}  \mathit{y}  \hookleftarrow   \tau'_{{\mathrm{1}}}  \TREF^{ r }   \ottsym{]}  \ottsym{,}  \mathit{x}  \ottsym{:}  \tau'_{{\mathrm{2}}}   \vdash   \ottnt{e}  :  \tau   \produces   \Gamma'  \\
   \mathit{x}  \not\in   \DOM( \Gamma' )  
}{
   \Theta   \mid   \mathcal{L}   \mid   \Gamma  \ottsym{[}  \mathit{y}  \ottsym{:}   \ottsym{(}  \tau_{{\mathrm{1}}}  \ottsym{+}  \tau_{{\mathrm{2}}}  \ottsym{)}  \TREF^{ r }   \ottsym{]}   \vdash    \LET  \mathit{x}  =   *  \mathit{y}   \IN  \ottnt{e}   :  \tau   \produces   \Gamma' 
}

\infrule[T-MkRef]{
   \Theta   \mid   \mathcal{L}   \mid   \Gamma  \ottsym{[}  \mathit{y}  \hookleftarrow  \tau_{{\mathrm{1}}}  \wedge \, \nu \, \ottsym{=}  \mathit{x} \,  \star   \ottsym{]}  \ottsym{,}  \mathit{x}  \ottsym{:}   \ottsym{(}  \tau_{{\mathrm{2}}}  \wedge \, \nu \, \ottsym{=}  \mathit{y}  \ottsym{)}  \TREF^{ \ottsym{1} }    \vdash   \ottnt{e}  :  \tau   \produces   \Gamma'  \\
   \mathit{x}  \not\in   \DOM( \Gamma' )  
}{  \Theta   \mid   \mathcal{L}   \mid   \Gamma  \ottsym{[}  \mathit{y}  \ottsym{:}  \tau_{{\mathrm{1}}}  \ottsym{+}  \tau_{{\mathrm{2}}}  \ottsym{]}   \vdash    \LET  \mathit{x}  =   \MKREF  \mathit{y}   \IN  \ottnt{e}   :  \tau   \produces   \Gamma'  }

\infrule[T-Call]{
  \sigma_{\alpha}  \ottsym{=}  \ottsym{[}  \ell  \ottsym{:}  \mathcal{L}  \ottsym{/}  \lambda  \ottsym{]} \andalso \sigma_{x}  \ottsym{=}    [  \mathit{y_{{\mathrm{1}}}}  /  \mathit{x_{{\mathrm{1}}}}  ]  \cdots  [  \mathit{y_{\ottmv{n}}}  /  \mathit{x_{\ottmv{n}}}  ]   \\
  \Theta  \ottsym{(}  \mathit{f}  \ottsym{)}  \ottsym{=}   \forall  \lambda .\tuple{ \mathit{x_{{\mathrm{1}}}} \COL \tau_{{\mathrm{1}}} ,\dots, \mathit{x_{\ottmv{n}}} \COL \tau_{\ottmv{n}} }\ra\tuple{ \mathit{x_{{\mathrm{1}}}} \COL \tau'_{{\mathrm{1}}} ,\dots, \mathit{x_{\ottmv{n}}} \COL \tau'_{\ottmv{n}}  \mid  \tau }  \\
  \Gamma_{{\mathrm{1}}}  \ottsym{(}  \mathit{y_{\ottmv{i}}}  \ottsym{)}  \ottsym{=}  \tau''_{\ottmv{i}}  \ottsym{+}  \sigma_{\alpha} \, \sigma_{x} \, \tau_{\ottmv{i}} \\
  \Gamma_{{\mathrm{2}}}  \ottsym{[}  \mathit{y_{\ottmv{i}}}  \hookleftarrow  \tau''_{\ottmv{i}}  \ottsym{]} \andalso  \mathcal{L}   \vdash _{\wf}  \Gamma_{{\mathrm{2}}}  \\
  \Gamma_{{\mathrm{3}}}  \ottsym{=}  \Gamma_{{\mathrm{1}}}  \ottsym{[}  \mathit{y_{\ottmv{i}}}  \hookleftarrow  \tau''_{\ottmv{i}}  \ottsym{+}  \sigma_{\alpha} \, \sigma_{x} \, \tau'_{\ottmv{i}}  \ottsym{]}  \ottsym{,}  \mathit{z}  \ottsym{:}  \sigma_{\alpha} \, \sigma_{x} \, \tau \\
   \Theta   \mid   \mathcal{L}   \mid   \Gamma_{{\mathrm{3}}}   \vdash   \ottnt{e}  :  \tau'   \produces   \Gamma_{{\mathrm{4}}}  \andalso  \mathit{z}  \not\in   \DOM( \Gamma_{{\mathrm{4}}} )  
}{
   \Theta   \mid   \mathcal{L}   \mid   \Gamma_{{\mathrm{1}}}   \vdash    \LET  \mathit{z}  =   \mathit{f} ^ \ell (  \mathit{y_{{\mathrm{1}}}} ,\ldots, \mathit{y_{\ottmv{n}}}  )   \IN  \ottnt{e}   :  \tau'   \produces   \Gamma_{{\mathrm{4}}} 
}

\infrule[T-Frame]{
   \mathcal{L}   \vdash _{\wf}  \Gamma_{\ottmv{p}}  \\
   \Theta   \mid   \mathcal{L}   \mid   \Gamma   \vdash   \ottnt{e}  :  \tau   \produces   \Gamma' 
}{
   \Theta   \mid   \mathcal{L}   \mid   \Gamma  \ottsym{+}  \Gamma_{\ottmv{p}}   \vdash   \ottnt{e}  :  \tau   \produces   \Gamma'  \ottsym{+}  \Gamma_{\ottmv{p}} 
}
  

\section{Proofs}

Define the partial type lookup operation $\Gamma  \ottsym{(}  \pi  \ottsym{)}$ as:

\begin{align*}
  \Gamma  \ottsym{(}  \mathit{x} \, \oldvec{\star}  \ottsym{)} & = \Gamma  \ottsym{(}  \mathit{x}  \ottsym{)}  \ottsym{(}  \oldvec{\star}  \ottsym{)} \\
  \tau  \ottsym{(}   \epsilon   \ottsym{)} & = \tau \\
  \ottsym{(}   \tau'  \TREF^{ r }   \ottsym{)}  \ottsym{(}   \star  \, \oldvec{\star}  \ottsym{)} & = \tau'  \ottsym{(}  \oldvec{\star}  \ottsym{)}
\end{align*}

\JT{defining this traversal as a map operation on $\tau$ is gross}

$\ottsym{[}  \ottnt{H}  \ottsym{,}  \ottnt{v}  \ottsym{]}$ is the partial function from $\oldvec{\star}$ to values $v$
defined by

\begin{align*}
  \ottsym{[}  \ottnt{H}  \ottsym{,}  \ottnt{v}  \ottsym{]}  \ottsym{(}   \epsilon   \ottsym{)} \, \ottsym{=} \, \ottnt{v} && \ottsym{[}  \ottnt{H}  \ottsym{,}  \ottnt{v}  \ottsym{]}  \ottsym{(}   \star  \, \oldvec{\star}  \ottsym{)} = \begin{cases}
    H(a) & \text{if } \ottsym{[}  \ottnt{H}  \ottsym{,}  \ottnt{v}  \ottsym{]}  \ottsym{(}  \oldvec{\star}  \ottsym{)} \, \ottsym{=} \, \ottmv{a}  \wedge   \ottmv{a}  \in   \DOM( \ottnt{H} )   \\
    \mathit{undef} & o.w.
  \end{cases}
\end{align*}

$\ottsym{[}  \ottnt{H}  \ottsym{,}  \ottnt{R}  \ottsym{]}$ is the partial map from $\pi$ to values $v$ defined by
$\ottsym{[}  \ottnt{H}  \ottsym{,}  \ottnt{R}  \ottsym{]}  \ottsym{(}  \mathit{x} \, \oldvec{\star}  \ottsym{)} \, \ottsym{=} \, \ottsym{[}  \ottnt{H}  \ottsym{,}  \ottnt{R}  \ottsym{(}  \mathit{x}  \ottsym{)}  \ottsym{]}  \ottsym{(}  \oldvec{\star}  \ottsym{)}$

\begin{lemma}\label{lemma:framed-update-pred}
  If $ \mathcal{L}   \mid    \Gamma  \setminus  \mathit{x}    \vdash _{\wf}  \varphi $ and for all $y \neq x$ we have
  $\ottkw{own} \, \ottsym{(}  \ottnt{H}  \ottsym{,}  \ottnt{R}  \ottsym{(}  \mathit{y}  \ottsym{)}  \ottsym{,}  \Gamma  \ottsym{(}  \mathit{y}  \ottsym{)}  \ottsym{)}  \ottsym{(}  \ottmv{a}  \ottsym{)}  \ottsym{=}  \ottsym{0}$, then $\ottsym{[}  \ottnt{H}  \ottsym{,}  \ottnt{R}  \ottsym{]} \, \ottsym{[}  n  \ottsym{/}  \nu  \ottsym{]}  \varphi$
  is equivalent to $\ottsym{[}  \ottnt{H}  \ottsym{\{}  \ottmv{a}  \hookleftarrow  v'  \ottsym{\}}  \ottsym{,}  \ottnt{R}  \ottsym{]} \, \ottsym{[}  n  \ottsym{/}  \nu  \ottsym{]}  \varphi$ where $\ottnt{R}  \ottsym{(}  \mathit{x}  \ottsym{)} \, \ottsym{=} \, \ottmv{a}$.
\end{lemma}
\begin{proof}
  Suppose not. Then there must be some access path $\pi$ in $\varphi$ such that
  for some prefix of the path (called $\pi'$) we have $\ottsym{[}  \ottnt{H}  \ottsym{,}  \ottnt{R}  \ottsym{]}  \ottsym{(}  \pi'  \ottsym{)} \, \ottsym{=} \, \ottmv{a}$. From
  $ \mathcal{L}   \mid    \Gamma  \setminus  \mathit{x}    \vdash _{\wf}  \varphi $ we must have that $\pi'$ cannot be rooted in $\mathit{x}$,
  and must therefore be rooted in some other variable $\mathit{z}$, whereby
  $\ottkw{own} \, \ottsym{(}  \ottnt{H}  \ottsym{,}  \ottnt{R}  \ottsym{(}  \mathit{z}  \ottsym{)}  \ottsym{,}  \Gamma  \ottsym{(}  \mathit{z}  \ottsym{)}  \ottsym{)}  \ottsym{(}  \ottmv{a}  \ottsym{)}  \ottsym{=}  \ottsym{0}$. But we must then have $\Gamma  \ottsym{(}  \pi'  \ottsym{)}  \ottsym{=}   \tau'  \TREF^{ \ottsym{0} } $, which
  contradicts our assumption that $ \mathcal{L}   \mid    \Gamma  \setminus  \mathit{x}    \vdash _{\wf}  \varphi $.
\end{proof}

\begin{lemma}
  For any $\mathit{x}, \ottmv{a}, \ottnt{R}, \ottnt{H}$, $\Gamma$, and $n$ such that
  $\ottnt{R}  \ottsym{(}  \mathit{x}  \ottsym{)} \, \ottsym{=} \, \ottmv{a}$, $ \ottnt{H} \vdash   v'  \Downarrow  n $, $ \ottnt{H} \vdash   \ottnt{H}  \ottsym{(}  \ottmv{a}  \ottsym{)}  \Downarrow  n $ and where for all
  $y \neq x$ we have $\ottkw{own} \, \ottsym{(}  \ottnt{H}  \ottsym{,}  \ottnt{R}  \ottsym{(}  \mathit{y}  \ottsym{)}  \ottsym{,}  \Gamma  \ottsym{(}  \mathit{y}  \ottsym{)}  \ottsym{)}  \ottsym{(}  \ottmv{a}  \ottsym{)}  \ottsym{=}  \ottsym{0}$:
  \begin{enumerate}
  \item $ \ottnt{H}  \ottsym{\{}  \ottmv{a}  \hookleftarrow  v'  \ottsym{\}} \vdash   v'  \Downarrow  n $
  \item If $ \mathcal{L}   \mid    \Gamma  \setminus  \mathit{x}    \vdash _{\wf}  \tau $, $\ottkw{own} \, \ottsym{(}  \ottnt{H}  \ottsym{,}  v  \ottsym{,}  \tau  \ottsym{)}  \ottsym{(}  \ottmv{a}  \ottsym{)}  \ottsym{=}  \ottsym{0}$, and $ \ottkw{SATv} ( \ottnt{H} , \ottnt{R} , v , \tau ) $
    then $ \ottkw{SATv} ( \ottnt{H}  \ottsym{\{}  \ottmv{a}  \hookleftarrow  \ottnt{v'}  \ottsym{\}} , \ottnt{R} , v , \tau ) $.
  \item If $ \mathcal{L}   \vdash _{\wf}   \Gamma  \setminus  \mathit{x}  $, and $ \ottkw{SATv} ( \ottnt{H} , \ottnt{R} , v , \Gamma  \ottsym{(}  \mathit{z}  \ottsym{)} ) $, then $ \ottkw{SATv} ( \ottnt{H}  \ottsym{\{}  \ottmv{a}  \hookleftarrow  v  \ottsym{\}} , \ottnt{R} , v , \Gamma  \ottsym{(}  \mathit{z}  \ottsym{)} ) $
  \end{enumerate}
\end{lemma}
\begin{proof}\leavevmode
  \begin{enumerate}
  \item From $ \ottnt{H} \vdash   v'  \Downarrow  n $ and $ \ottnt{H} \vdash   \ottnt{H}  \ottsym{(}  \ottmv{a}  \ottsym{)}  \Downarrow  n $, we must have that for
    any possible sequence $\oldvec{\star}$, $\ottsym{[}  \ottnt{H}  \ottsym{,}  v'  \ottsym{]}  \ottsym{(}  \oldvec{\star}  \ottsym{)} \, \neq \, \ottmv{a}$ (if we did, then
    we would have that $v$ reaches an integer along paths of different lengths, a clear
    contradiction). Then the value of $\ottmv{a}$ in $\ottnt{H}$ is irrelevant to the derivation
    of $ \ottnt{H} \vdash   v'  \Downarrow  n $, giving $ \ottnt{H}  \ottsym{\{}  \ottmv{a}  \hookleftarrow  v'  \ottsym{\}} \vdash   v'  \Downarrow  n $.
  \item By induction on the shape of $\tau$. In the base case where $\tau  \ottsym{=}   \set{  \nu  \COL \TINT \mid  \varphi } $, from $ \mathcal{L}   \mid    \Gamma  \setminus  \mathit{x}    \vdash _{\wf}  \tau $
    we have $ \mathcal{L}   \mid    \Gamma  \setminus  \mathit{x}    \vdash _{\wf}  \varphi $, where by from \Cref{lemma:framed-update-pred} we have $\ottsym{[}  \ottnt{H}  \ottsym{,}  \ottnt{R}  \ottsym{]} \, \ottsym{[}  n  \ottsym{/}  \nu  \ottsym{]}  \varphi$ is equivalent to
    $\ottsym{[}  \ottnt{H}  \ottsym{\{}  \ottmv{a}  \hookleftarrow  v'  \ottsym{\}}  \ottsym{,}  \ottnt{R}  \ottsym{]} \, \ottsym{[}  n  \ottsym{/}  \nu  \ottsym{]}  \varphi$ whereby the result holds by assumption.

    In the inductive step, we have $\tau  \ottsym{=}   \tau'  \TREF^{ r } $, and $v \, \ottsym{=} \, \ottmv{a'}$.
    Suppose $\ottmv{a} \, \ottsym{=} \, \ottmv{a'}$: from $\ottkw{own} \, \ottsym{(}  \ottnt{H}  \ottsym{,}  v  \ottsym{,}  \tau  \ottsym{)}  \ottsym{(}  \ottmv{a}  \ottsym{)}  \ottsym{=}  \ottsym{0}$ we must then have $r  \ottsym{=}  \ottsym{0}$,
    whereby $\tau'  \ottsym{=}  \top_{\ottmv{n}}$. From \Cref{lem:top-type-path-sat}, item 1 above,
    \JT{the lemma that any shape consistent values satisfy the top type}, we have
    $ \ottkw{SATv} ( \ottnt{H}  \ottsym{\{}  \ottmv{a}  \hookleftarrow  v'  \ottsym{\}} , \ottnt{R} , \ottmv{a} , \tau ) $.

    Otherwise $\ottmv{a} \, \neq \, \ottmv{a'}$ in which case the result holds by inversion on
    $ \mathcal{L}   \mid    \Gamma  \setminus  \mathit{x}    \vdash _{\wf}  \tau $, $\ottkw{own} \, \ottsym{(}  \ottnt{H}  \ottsym{,}  v  \ottsym{,}   \tau'  \TREF^{ r }   \ottsym{)}  \ottsym{(}  \ottmv{a}  \ottsym{)}  \ottsym{=}  \ottsym{0}$ and the inductive hypothesis.

  \item Immediate result of item 2.
  \end{enumerate}
\end{proof}

\begin{lemma}[Preservation]
  For any $\ottnt{e}$ where $ \Theta   \mid   \mathcal{L}   \mid   \Gamma_{{\mathrm{1}}}   \vdash   \ottnt{e}  :  \tau   \produces   \Gamma_{{\mathrm{2}}} $,
  for all $\ottnt{e'}$ and $\ottnt{E}$ such that
  $\Theta  \mid  \HOLE  \ottsym{:}  \tau  \produces  \Gamma_{{\mathrm{2}}}  \mid  \mathcal{L}  \vdash_{\mathit{ectx} }  \ottnt{E}  \ottsym{:}  \tau'  \produces  \Gamma_{{\mathrm{3}}}$ if
  $  \tuple{ \ottnt{H} ,  \ottnt{R} ,  \oldvec{F} ,  \ottnt{E}  \ottsym{[}  \ottnt{e}  \ottsym{]} }     \longrightarrow _{ \ottnt{D} }     \tuple{ \ottnt{H} ,  \ottnt{R} ,  \oldvec{F} ,  \ottnt{E}  \ottsym{[}  \ottnt{e'}  \ottsym{]} }  $, $ \mathcal{L}   \vdash _{\wf}  \Gamma_{\ottmv{p}} $ and
  $\ottkw{Cons} \, \ottsym{(}  \ottnt{H}  \ottsym{,}  \ottnt{R}  \ottsym{,}  \Gamma_{{\mathrm{1}}}  \ottsym{+}  \Gamma_{\ottmv{p}}  \ottsym{)}$ then there exists some $\Gamma_{{\mathrm{4}}}$ such that
  \begin{enumerate}
  \item $\ottkw{Cons} \, \ottsym{(}  \ottnt{H'}  \ottsym{,}  \ottnt{R'}  \ottsym{,}  \Gamma_{{\mathrm{4}}}  \ottsym{+}  \Gamma_{\ottmv{p}}  \ottsym{)}$
  \item $ \Theta   \mid   \mathcal{L}   \mid   \Gamma_{{\mathrm{4}}}   \vdash   \ottnt{e'}  :  \tau   \produces   \Gamma_{{\mathrm{2}}} $
  \end{enumerate}
\end{lemma}
\begin{proof}
  By induction on the derivation of $ \Theta   \mid   \mathcal{L}   \mid   \Gamma_{{\mathrm{1}}}   \vdash   \ottnt{e}  :  \tau   \produces   \Gamma_{{\mathrm{2}}} $.
  \begin{rncase}{T-Sub}
    By the inductive hypothesis, that $\ottkw{Own}$ is anti-monotone w.r.t the subtyping
    relation \admitted{}, and the preservation of $\ottkw{Cons}$ by subtyping
    \admitted{} (\Cref{lem:subtyping-preserves-cons}).
  \end{rncase}
  \begin{rncase}{T-Frame}
    Then we have that $ \Theta   \mid   \mathcal{L}   \mid   \Gamma'_{{\mathrm{1}}}   \vdash   \ottnt{e}  :  \tau   \produces   \Gamma'_{{\mathrm{2}}} $ where
    $\Gamma_{{\mathrm{1}}}  \ottsym{=}  \Gamma'_{{\mathrm{1}}}  \ottsym{+}  \Gamma''_{{\mathrm{1}}}$ and $\Gamma_{{\mathrm{2}}}  \ottsym{=}  \Gamma'_{{\mathrm{2}}}  \ottsym{+}  \Gamma'_{{\mathrm{1}}}$ and where $ \mathcal{L}   \vdash _{\wf}  \Gamma'_{{\mathrm{1}}} $.
    We have $\ottkw{Cons} \, \ottsym{(}  \ottnt{H}  \ottsym{,}  \ottnt{R}  \ottsym{,}  \Gamma'_{{\mathrm{1}}}  \ottsym{+}  \Gamma''_{{\mathrm{1}}}  \ottsym{+}  \Gamma_{\ottmv{p}}  \ottsym{)}$. We must then have that $ \mathcal{L}   \vdash _{\wf}  \Gamma'_{{\mathrm{1}}}  \ottsym{+}  \Gamma_{\ottmv{p}} $
    by \admitted[WF is closed under +].
    Taking $\Gamma_{\ottmv{p}}$ in the inductive hypothesis to be $\Gamma_{\ottmv{p}}  \ottsym{+}  \Gamma'_{{\mathrm{1}}}$, we
    then have that $\ottkw{Cons} \, \ottsym{(}  \ottnt{H'}  \ottsym{,}  \ottnt{R'}  \ottsym{,}  \Gamma'_{{\mathrm{4}}}  \ottsym{+}  \Gamma_{\ottmv{p}}  \ottsym{+}  \Gamma'_{{\mathrm{1}}}  \ottsym{)}$ and
    $ \Theta   \mid   \mathcal{L}   \mid   \Gamma'_{{\mathrm{4}}}   \vdash   \ottnt{e'}  :  \tau   \produces   \Gamma'_{{\mathrm{2}}} $. We take $\Gamma_{{\mathrm{4}}}  \ottsym{=}  \Gamma'_{{\mathrm{4}}}  \ottsym{+}  \Gamma'_{{\mathrm{1}}}$. Then, by an
    application of \rn{T-Frame} we have $ \Theta   \mid   \mathcal{L}   \mid   \Gamma_{{\mathrm{4}}}   \vdash   \ottnt{e'}  :  \tau   \produces   \Gamma_{{\mathrm{2}}} $, and
    we then have $\ottkw{Cons} \, \ottsym{(}  \ottnt{H'}  \ottsym{,}  \ottnt{R'}  \ottsym{,}  \Gamma_{{\mathrm{4}}}  \ottsym{+}  \Gamma_{\ottmv{p}}  \ottsym{)}$ from $\ottkw{Cons} \, \ottsym{(}  \ottnt{H'}  \ottsym{,}  \ottnt{R'}  \ottsym{,}  \Gamma'_{{\mathrm{4}}}  \ottsym{+}  \Gamma'_{{\mathrm{1}}}  \ottsym{+}  \Gamma_{\ottmv{p}}  \ottsym{)}$.
  \end{rncase}

  \begin{rneqncase}{T-Assign}{
      \ottnt{e}  \ottsym{=}   \mathit{y}  \WRITE  \mathit{x}  \SEQ  \ottnt{e''}  & \Gamma_{{\mathrm{1}}}  \ottsym{(}  \mathit{x}  \ottsym{)}  \ottsym{=}  \tau_{{\mathrm{1}}}  \ottsym{+}  \tau_{{\mathrm{2}}} & \Gamma_{{\mathrm{1}}}  \ottsym{(}  \mathit{y}  \ottsym{)}  \ottsym{=}   \tau'  \TREF^{ \ottsym{1} }  \\
       | \tau' |  \, \ottsym{=} \,  | \tau_{{\mathrm{1}}}  \ottsym{+}  \tau_{{\mathrm{2}}} |  &  \mathcal{L}   \vdash _{\wf}   \Gamma_{{\mathrm{1}}}  \setminus  \mathit{y}   \\
      \multicolumn{4}{l}{ \Theta   \mid   \mathcal{L}   \mid   \Gamma  \ottsym{[}  \mathit{x}  \hookleftarrow  \tau_{{\mathrm{1}}}  \wedge \, \nu \, \ottsym{=}  \mathit{y} \,  \star   \ottsym{]}  \ottsym{[}  \mathit{y}  \hookleftarrow   \ottsym{(}  \tau_{{\mathrm{2}}}  \wedge \, \nu \, \ottsym{=}  \mathit{x}  \ottsym{)}  \TREF^{ \ottsym{1} }   \ottsym{]}   \vdash   \ottnt{e'}  :  \tau   \produces   \Gamma_{{\mathrm{2}}} } \\
      \ottmv{a} \, \ottsym{=} \, \ottnt{R}  \ottsym{(}  \mathit{y}  \ottsym{)} & \ottnt{H'}  \ottsym{=}  \ottnt{H}  \ottsym{\{}  \ottmv{a}  \hookleftarrow  \ottnt{R}  \ottsym{(}  \mathit{x}  \ottsym{)}  \ottsym{\}} & \ottnt{R}  \ottsym{=}  \ottnt{R'} & \ottnt{e''}  \ottsym{=}  \ottnt{e'}
    }
    From $\ottkw{Cons} \, \ottsym{(}  \ottnt{H}  \ottsym{,}  \ottnt{R}  \ottsym{,}  \Gamma_{{\mathrm{1}}}  \ottsym{+}  \Gamma_{\ottmv{p}}  \ottsym{)}$ and from $\Gamma_{{\mathrm{1}}}  \ottsym{(}  \mathit{y}  \ottsym{)}  \ottsym{=}   \tau'  \TREF^{ \ottsym{1} } $ we must have that
    for any variable $ \mathit{z}  \in   \DOM( \Gamma_{{\mathrm{1}}} )  , z \neq y$ that
    $\ottkw{own} \, \ottsym{(}  \ottnt{H}  \ottsym{,}  \ottnt{R}  \ottsym{(}  \mathit{z}  \ottsym{)}  \ottsym{,}  \Gamma_{{\mathrm{1}}}  \ottsym{(}  \mathit{z}  \ottsym{)}  \ottsym{)}  \ottsym{(}  \ottmv{a}  \ottsym{)}  \ottsym{=}  \ottsym{0}$ and similarly for all variables in $ \DOM( \Gamma_{\ottmv{p}} ) $.

    We must also have that if $ \mathit{y}  \in \DOM( \Gamma_{\ottmv{p}} ) $ that $\Gamma  \ottsym{(}  \mathit{y}  \ottsym{)}  \ottsym{=}   \top_{\ottmv{n}}  \TREF^{ \ottsym{0} } $. Then by
    \admitted[0 references are not referenced in types], we have $ \mathcal{L}   \vdash _{\wf}   \Gamma_{\ottmv{p}}  \setminus  \mathit{y}  $.

    Next, from \admitted[SATv implies shape consistency], from $ \ottkw{SATv} ( \ottnt{H} , \ottnt{R} , \ottnt{R}  \ottsym{(}  \mathit{y}  \ottsym{)} ,  \tau'  \TREF^{ \ottsym{1} }  ) $ we have that $ \ottnt{H} \vdash   \ottnt{R}  \ottsym{(}  \mathit{y}  \ottsym{)}  \Downarrow   |  \tau'  \TREF^{ \ottsym{1} }  |  $, whereby we have $ \ottnt{H} \vdash   \ottnt{H}  \ottsym{(}  \ottnt{R}  \ottsym{(}  \mathit{y}  \ottsym{)}  \ottsym{)}  \Downarrow   | \tau' |  $. Similarly, from $ \ottkw{SATv} ( \ottnt{H} , \ottnt{R} , \ottnt{R}  \ottsym{(}  \mathit{x}  \ottsym{)} , \tau_{{\mathrm{1}}}  \ottsym{+}  \tau_{{\mathrm{2}}} ) $ we have $ \ottnt{H} \vdash   \ottnt{R}  \ottsym{(}  \mathit{x}  \ottsym{)}  \Downarrow   | \tau_{{\mathrm{1}}}  \ottsym{+}  \tau_{{\mathrm{1}}} |  $.

    From the above, our assumption $ \mathcal{L}   \vdash _{\wf}   \Gamma_{{\mathrm{1}}}  \setminus  \mathit{y}  $ and  \Cref{lemma:framed-update-pred}
    we then have $ \ottkw{SATv} ( \ottnt{H'} , \ottnt{R} , \ottnt{R}  \ottsym{(}  \mathit{z}  \ottsym{)} , \Gamma_{{\mathrm{1}}}  \ottsym{(}  \mathit{z}  \ottsym{)} ) $ for any $\mathit{z} \, \neq \, \mathit{x}$ and
    $\mathit{z} \, \neq \, \mathit{y}$.

    Similarly, we must have that $ \ottkw{SATv} ( \ottnt{H'} , \ottnt{R} , \ottnt{R}  \ottsym{(}  \mathit{z}  \ottsym{)} , \Gamma_{\ottmv{p}}  \ottsym{(}  \mathit{z}  \ottsym{)} ) $ by the reasoning above
    and \Cref{lemma:framed-update-pred}.

    We must also have that $ \ottkw{SATv} ( \ottnt{H'} , \ottnt{R} , \ottnt{R}  \ottsym{(}  \mathit{x}  \ottsym{)} , \tau_{{\mathrm{1}}}  \ottsym{+}  \tau_{{\mathrm{2}}} ) $. From \admitted[SATv distributes
    over +], we therefore
    have $ \ottkw{SATv} ( \ottnt{H'} , \ottnt{R} , \ottnt{R}  \ottsym{(}  \mathit{x}  \ottsym{)} , \tau_{{\mathrm{1}}} ) $ and $ \ottkw{SATv} ( \ottnt{H'} , \ottnt{R} , \ottnt{R}  \ottsym{(}  \mathit{x}  \ottsym{)} , \tau_{{\mathrm{2}}} ) $. It is then immediate
    that $ \ottkw{SATv} ( \ottnt{H'} , \ottnt{R} , \ottnt{R}  \ottsym{(}  \mathit{x}  \ottsym{)} , \tau_{{\mathrm{1}}}  \wedge \, \nu \, \ottsym{=}  \mathit{y} \,  \star  ) $ and $ \ottkw{SATv} ( \ottnt{H'} , \ottnt{R} , \ottnt{R}  \ottsym{(}  \mathit{x}  \ottsym{)} , \tau_{{\mathrm{2}}}  \wedge \, \nu \, \ottsym{=}  \mathit{x} ) $.
    From the latter we then have $ \ottkw{SATv} ( \ottnt{H'} , \ottnt{R} , \ottnt{R}  \ottsym{(}  \mathit{y}  \ottsym{)} ,  \ottsym{(}  \tau_{{\mathrm{2}}}  \wedge \, \nu \, \ottsym{=}  \mathit{x}  \ottsym{)}  \TREF^{ \ottsym{1} }  ) $.

    \JT{The ownership reasoning is entirely similar to the ESOP paper. We can use that
      $\ottkw{Cons} \, \ottsym{(}  \ottnt{H}  \ottsym{,}  \ottnt{R}  \ottsym{,}  \Gamma_{{\mathrm{1}}}  \ottsym{+}  \Gamma_{\ottmv{p}}  \ottsym{)}$ and that ownership is only lost in $\Gamma_{{\mathrm{1}}}$ to re-establish
      ownership consistency for $\Gamma_{{\mathrm{4}}}  \ottsym{+}  \Gamma_{\ottmv{p}}$}
    
    We take $\Gamma_{{\mathrm{4}}}  \ottsym{=}  \Gamma  \ottsym{[}  \mathit{x}  \hookleftarrow  \tau_{{\mathrm{1}}}  \wedge \, \nu \, \ottsym{=}  \mathit{y} \,  \star   \ottsym{]}  \ottsym{[}  \mathit{y}  \hookleftarrow   \ottsym{(}  \tau_{{\mathrm{2}}}  \wedge \, \nu \, \ottsym{=}  \mathit{x}  \ottsym{)}  \TREF^{ \ottsym{1} }   \ottsym{]}$ whereby
    from \admitted[adding SATv envs is Cons]
    and the previous reasoning we have $\ottkw{Cons} \, \ottsym{(}  \ottnt{H'}  \ottsym{,}  \ottnt{R'}  \ottsym{,}  \Gamma_{{\mathrm{4}}}  \ottsym{+}  \Gamma_{\ottmv{p}}  \ottsym{)}$.
    That $ \Theta   \mid   \mathcal{L}   \mid   \Gamma_{{\mathrm{4}}}   \vdash   \ottnt{e'}  :  \tau   \produces   \Gamma_{{\mathrm{2}}} $ is immediate from our assumption.
  \end{rneqncase}
    
\end{proof}


\end{document}
%%% Local Variables:
%%% mode: latex
%%% TeX-master: t
%%% End:
